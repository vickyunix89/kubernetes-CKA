# Securing ETCD

## Generating certificates

The etcd datastore has the concept of users that are linked to roles, where each role has a defined set of access permissions to the data stored in etcd. This tutorial walks you through the process of generating the Certificate Authority (CA), Certificates and Keys that can be used to authenticate a specific user with etcd. There are many different tools that can be used to generate these files. This tutorial tries to layout the unique or specific details that are needed for each of the different certificates but uses the hack/tls-setup tool from the etcd repo, to make certificate generation easy.


Generating the certificates creates:

* CA
* a certificate and key pair for 3 etcd servers
* a certificate and key pair for etcd proxies
* the certificate and key pairs for each user/component

Edit the below CSR - 

```
{
  "CN": "<etcd_username>",
  "hosts": [
    "localhost"
  ],
  "key": {
    "algo": "ecdsa",           
    "size": 384                
  },  
  "names": [
    {
      "O": "autogenerated",    
      "OU": "etcd cluster",
      "L": "the internet"
    }
  ]   
}

```

Execute the below to generate certificates -


```

    $(CFSSL) gencert \
      -ca certs/ca.pem \
      -ca-key certs/ca-key.pem \
      -config config/ca-config.json \
      config/req-<component>.json | $(JSON) -bare certs/<component>

```

## Create ETCD user & roles 

There is one special user, root, and one special role, root.

* User root
The root user, which has full access to etcd, must be created before activating authentication. The idea behind the root user is for administrative purposes: managing roles and ordinary users. The root user must have the root role and is allowed to change anything inside etcd.

* Role root
The role root may be granted to any user, in addition to the root user. A user with the root role has both global read-write access and permission to update the cluster's authentication configuration. Furthermore, the root role grants privileges for general cluster maintenance, including modifying cluster membership, defragmenting the store, and taking snapshots.

Create user - 

```
etcdctl user add myusername

```

Grant Roles 

```
$ etcdctl user grant-role myusername foo
$ etcdctl user revoke-role myusername bar

```

## ETCD segmentation 


When using etcd with RBAC, all components that access etcd must be configured with the proper certificates. This document describes the users and roles needed to segment etcd so that Kubernetes and Calico can only read and write within their respected subtrees/prefixes. To configure more compartmentalized configurations of the Calico components.


The following components need certificates with a Common Name that matches an etcd user that has been given appropriate roles allowing access to the key prefixes or paths listed below.

**kube-apiserver**

Read and write access to /registry/. The etcd user needs to be given the root role to perform compaction when using the etcd v3 API (this also means that Kubernetes will have full read and write access to v3 data).

```
--etcd-cafile=<CA certificate
--etcd-certfile=<certificate with etcd username as CN>
--etcd-keyfile=<key for the above certificate>

```

**Calico**

Read and write access to /calico/. All certificate/key pairs that are referenced below are assumed to have been created for the specific component with the information above.

```
etcd_ca: "/calico-secrets/etcd-ca"
etcd_cert: "/calico-secrets/etcd-cert"
etcd_key: "/calico-secrets/etcd-key"

```
